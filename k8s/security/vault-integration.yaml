# HashiCorp Vault Integration for CarRental SaaS
# Enterprise secrets management with Vault

# Vault namespace
apiVersion: v1
kind: Namespace
metadata:
  name: vault
  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/part-of: carrental-saas

---
# Vault ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vault
  namespace: vault
  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/component: server
    app.kubernetes.io/part-of: carrental-saas

---
# Vault RBAC
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: vault-server
  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/component: server
    app.kubernetes.io/part-of: carrental-saas
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["list"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: vault-server-binding
  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/component: server
    app.kubernetes.io/part-of: carrental-saas
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: vault-server
subjects:
- kind: ServiceAccount
  name: vault
  namespace: vault

---
# Vault ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-config
  namespace: vault
  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/component: config
    app.kubernetes.io/part-of: carrental-saas
data:
  vault.hcl: |
    ui = true

    listener "tcp" {
      address = "0.0.0.0:8200"
      tls_cert_file = "/vault/tls/tls.crt"
      tls_key_file  = "/vault/tls/tls.key"
      tls_client_ca_file = "/vault/tls/ca.crt"
    }

    storage "consul" {
      address = "consul.vault.svc.cluster.local:8500"
      path    = "vault/"
    }

    # Alternative: Kubernetes storage backend
    # storage "kubernetes" {
    #   namespace = "vault"
    # }

    # Seal configuration (auto-unseal with cloud KMS)
    seal "awskms" {
      region     = "us-east-1"
      kms_key_id = "alias/carrental-vault-key"
    }

    # Alternative: Azure Key Vault
    # seal "azurekeyvault" {
    #   tenant_id      = "your-tenant-id"
    #   client_id      = "your-client-id"
    #   client_secret  = "your-client-secret"
    #   vault_name     = "carrental-vault"
    #   key_name       = "vault-key"
    # }

    # Alternative: GCP KMS
    # seal "gcpckms" {
    #   project     = "carrental-project"
    #   region      = "global"
    #   key_ring    = "vault-keyring"
    #   crypto_key  = "vault-key"
    # }

    api_addr = "https://vault.vault.svc.cluster.local:8200"
    cluster_addr = "https://vault.vault.svc.cluster.local:8201"

    log_level = "INFO"
    raw_storage_endpoint = true

---
# Vault StatefulSet
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: vault
  namespace: vault
  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/component: server
    app.kubernetes.io/part-of: carrental-saas
spec:
  serviceName: vault-headless
  replicas: 3
  selector:
    matchLabels:
      app.kubernetes.io/name: vault
      app.kubernetes.io/component: server
  template:
    metadata:
      labels:
        app.kubernetes.io/name: vault
        app.kubernetes.io/component: server
        app.kubernetes.io/part-of: carrental-saas
    spec:
      serviceAccountName: vault
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                app.kubernetes.io/name: vault
                app.kubernetes.io/component: server
            topologyKey: kubernetes.io/hostname
      containers:
      - name: vault
        image: vault:1.15.2
        imagePullPolicy: IfNotPresent
        command:
        - "/bin/sh"
        - "-ec"
        args:
        - |
          cp /vault/config/vault.hcl /tmp/storageconfig.hcl;
          [ -n "${HOST_IP}" ] && sed -Ei "s|HOST_IP|${HOST_IP?}|g" /tmp/storageconfig.hcl;
          [ -n "${POD_IP}" ] && sed -Ei "s|POD_IP|${POD_IP?}|g" /tmp/storageconfig.hcl;
          [ -n "${HOSTNAME}" ] && sed -Ei "s|HOSTNAME|${HOSTNAME?}|g" /tmp/storageconfig.hcl;
          [ -n "${API_ADDR}" ] && sed -Ei "s|API_ADDR|${API_ADDR?}|g" /tmp/storageconfig.hcl;
          [ -n "${TRANSIT_ADDR}" ] && sed -Ei "s|TRANSIT_ADDR|${TRANSIT_ADDR?}|g" /tmp/storageconfig.hcl;
          [ -n "${RAFT_ADDR}" ] && sed -Ei "s|RAFT_ADDR|${RAFT_ADDR?}|g" /tmp/storageconfig.hcl;
          /usr/local/bin/docker-entrypoint.sh vault server -config=/tmp/storageconfig.hcl
        env:
        - name: HOST_IP
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: VAULT_K8S_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: VAULT_K8S_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: VAULT_ADDR
          value: "https://127.0.0.1:8200"
        - name: VAULT_API_ADDR
          value: "https://$(POD_IP):8200"
        - name: SKIP_CHOWN
          value: "true"
        - name: SKIP_SETCAP
          value: "true"
        - name: HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: VAULT_CLUSTER_ADDR
          value: "https://$(HOSTNAME).vault-headless:8201"
        ports:
        - containerPort: 8200
          name: http
        - containerPort: 8201
          name: https-internal
        readinessProbe:
          exec:
            command: ["/bin/sh", "-ec", "vault status -tls-skip-verify"]
          failureThreshold: 2
          initialDelaySeconds: 5
          periodSeconds: 5
          successThreshold: 1
          timeoutSeconds: 3
        resources:
          requests:
            memory: 256Mi
            cpu: 250m
          limits:
            memory: 1Gi
            cpu: 500m
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            add:
            - IPC_LOCK
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 100
          runAsGroup: 1000
        volumeMounts:
        - name: config
          mountPath: /vault/config
        - name: tls
          mountPath: /vault/tls
          readOnly: true
        - name: data
          mountPath: /vault/data
      volumes:
      - name: config
        configMap:
          name: vault-config
      - name: tls
        secret:
          secretName: vault-tls
          defaultMode: 420
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: "fast-ssd"
      resources:
        requests:
          storage: 10Gi

---
# Vault headless service
apiVersion: v1
kind: Service
metadata:
  name: vault-headless
  namespace: vault
  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/component: server
    app.kubernetes.io/part-of: carrental-saas
spec:
  clusterIP: None
  publishNotReadyAddresses: true
  ports:
  - name: http
    port: 8200
    targetPort: 8200
  - name: https-internal
    port: 8201
    targetPort: 8201
  selector:
    app.kubernetes.io/name: vault
    app.kubernetes.io/component: server

---
# Vault UI service
apiVersion: v1
kind: Service
metadata:
  name: vault
  namespace: vault
  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/component: server
    app.kubernetes.io/part-of: carrental-saas
spec:
  type: ClusterIP
  ports:
  - name: http
    port: 8200
    targetPort: 8200
    protocol: TCP
  selector:
    app.kubernetes.io/name: vault
    app.kubernetes.io/component: server

---
# Vault Agent for CarRental backend
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-agent-config
  namespace: carrental
  labels:
    app.kubernetes.io/name: vault-agent-config
    app.kubernetes.io/component: secrets
    app.kubernetes.io/part-of: carrental-saas
data:
  vault-agent.hcl: |
    exit_after_auth = false
    pid_file = "/home/vault/pidfile"

    auto_auth {
      method "kubernetes" {
        mount_path = "auth/kubernetes"
        config = {
          role = "carrental-backend"
        }
      }

      sink "file" {
        config = {
          path = "/home/vault/.vault-token"
        }
      }
    }

    vault {
      address = "https://vault.vault.svc.cluster.local:8200"
      ca_cert = "/vault/tls/ca.crt"
      retry {
        num_retries = 5
      }
    }

    template {
      source      = "/vault/templates/database.tpl"
      destination = "/vault/secrets/database.env"
      perms       = 0640
      command     = "sh -c 'kill -HUP $(cat /app/app.pid)'"
    }

    template {
      source      = "/vault/templates/jwt.tpl"
      destination = "/vault/secrets/jwt.env"
      perms       = 0640
    }

    template {
      source      = "/vault/templates/stripe.tpl"
      destination = "/vault/secrets/stripe.env"
      perms       = 0640
    }

---
# Vault templates ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-templates
  namespace: carrental
  labels:
    app.kubernetes.io/name: vault-templates
    app.kubernetes.io/component: secrets
    app.kubernetes.io/part-of: carrental-saas
data:
  database.tpl: |
    {{- with secret "database/creds/carrental-db" -}}
    SPRING_DATASOURCE_USERNAME="{{ .Data.username }}"
    SPRING_DATASOURCE_PASSWORD="{{ .Data.password }}"
    {{- end }}

  jwt.tpl: |
    {{- with secret "secret/carrental/jwt" -}}
    JWT_SECRET="{{ .Data.secret }}"
    JWT_EXPIRATION="{{ .Data.expiration }}"
    {{- end }}

  stripe.tpl: |
    {{- with secret "secret/carrental/stripe" -}}
    STRIPE_SECRET_KEY="{{ .Data.secret_key }}"
    STRIPE_PUBLISHABLE_KEY="{{ .Data.publishable_key }}"
    STRIPE_WEBHOOK_SECRET="{{ .Data.webhook_secret }}"
    {{- end }}

---
# External Secrets Operator integration with Vault
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-secret-store
  namespace: carrental
  labels:
    app.kubernetes.io/name: vault-secret-store
    app.kubernetes.io/component: secrets
    app.kubernetes.io/part-of: carrental-saas
spec:
  provider:
    vault:
      server: "https://vault.vault.svc.cluster.local:8200"
      path: "secret"
      version: "v2"
      caBundle: LS0tLS1CRUdJTi... # Base64 encoded CA certificate
      auth:
        kubernetes:
          mountPath: "auth/kubernetes"
          role: "carrental-backend"
          serviceAccountRef:
            name: "carrental-vault-auth"

---
# External Secret for database credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: carrental-database-vault
  namespace: carrental
  labels:
    app.kubernetes.io/name: carrental-database-vault
    app.kubernetes.io/component: secrets
    app.kubernetes.io/part-of: carrental-saas
spec:
  refreshInterval: 15s
  secretStoreRef:
    name: vault-secret-store
    kind: SecretStore
  target:
    name: carrental-database-secret
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        SPRING_DATASOURCE_USERNAME: "{{ .username }}"
        SPRING_DATASOURCE_PASSWORD: "{{ .password }}"
  data:
  - secretKey: username
    remoteRef:
      key: carrental/database
      property: username
  - secretKey: password
    remoteRef:
      key: carrental/database
      property: password

---
# External Secret for JWT configuration
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: carrental-jwt-vault
  namespace: carrental
  labels:
    app.kubernetes.io/name: carrental-jwt-vault
    app.kubernetes.io/component: secrets
    app.kubernetes.io/part-of: carrental-saas
spec:
  refreshInterval: 30s
  secretStoreRef:
    name: vault-secret-store
    kind: SecretStore
  target:
    name: carrental-jwt-secret
    creationPolicy: Owner
  data:
  - secretKey: JWT_SECRET
    remoteRef:
      key: carrental/jwt
      property: secret
  - secretKey: JWT_EXPIRATION
    remoteRef:
      key: carrental/jwt
      property: expiration

---
# Vault policy for CarRental backend
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-policies
  namespace: vault
  labels:
    app.kubernetes.io/name: vault-policies
    app.kubernetes.io/component: config
    app.kubernetes.io/part-of: carrental-saas
data:
  carrental-backend-policy.hcl: |
    # Allow reading application secrets
    path "secret/data/carrental/*" {
      capabilities = ["read"]
    }

    # Allow reading database credentials
    path "database/creds/carrental-db" {
      capabilities = ["read"]
    }

    # Allow PKI certificate generation
    path "pki/issue/carrental-backend" {
      capabilities = ["create", "update"]
    }

    # Allow reading CA certificate
    path "pki/ca/pem" {
      capabilities = ["read"]
    }

    # Transit encryption for sensitive data
    path "transit/encrypt/carrental" {
      capabilities = ["create", "update"]
    }

    path "transit/decrypt/carrental" {
      capabilities = ["create", "update"]
    }

---
# Vault init job
apiVersion: batch/v1
kind: Job
metadata:
  name: vault-init
  namespace: vault
  labels:
    app.kubernetes.io/name: vault-init
    app.kubernetes.io/component: init
    app.kubernetes.io/part-of: carrental-saas
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/name: vault-init
    spec:
      serviceAccountName: vault
      restartPolicy: OnFailure
      containers:
      - name: vault-init
        image: vault:1.15.2
        command:
        - /bin/sh
        - -c
        - |
          # Wait for Vault to be ready
          until vault status -address=https://vault.vault.svc.cluster.local:8200 -ca-cert=/vault/tls/ca.crt; do
            echo "Waiting for Vault to be ready..."
            sleep 5
          done

          # Initialize Vault if not already initialized
          if ! vault status -address=https://vault.vault.svc.cluster.local:8200 -ca-cert=/vault/tls/ca.crt | grep -q "Initialized.*true"; then
            echo "Initializing Vault..."
            vault operator init -address=https://vault.vault.svc.cluster.local:8200 -ca-cert=/vault/tls/ca.crt -key-shares=5 -key-threshold=3 > /vault/data/init-keys.txt
          fi

          echo "Vault initialization complete"
        env:
        - name: VAULT_ADDR
          value: "https://vault.vault.svc.cluster.local:8200"
        - name: VAULT_CACERT
          value: "/vault/tls/ca.crt"
        volumeMounts:
        - name: tls
          mountPath: /vault/tls
          readOnly: true
        - name: data
          mountPath: /vault/data
      volumes:
      - name: tls
        secret:
          secretName: vault-tls
      - name: data
        emptyDir: {}

---
# Network Policy for Vault
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: vault-network-policy
  namespace: vault
  labels:
    app.kubernetes.io/name: vault-network-policy
    app.kubernetes.io/component: security
    app.kubernetes.io/part-of: carrental-saas
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: vault
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow access from CarRental namespace
  - from:
    - namespaceSelector:
        matchLabels:
          name: carrental
    ports:
    - protocol: TCP
      port: 8200
  # Allow inter-Vault communication
  - from:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: vault
    ports:
    - protocol: TCP
      port: 8200
    - protocol: TCP
      port: 8201
  egress:
  # Allow DNS
  - to: []
    ports:
    - protocol: UDP
      port: 53
  # Allow HTTPS for cloud KMS
  - to: []
    ports:
    - protocol: TCP
      port: 443