name: CarRental Enterprise CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: ${{ github.repository }}/backend
  IMAGE_NAME_FRONTEND: ${{ github.repository }}/frontend
  JAVA_VERSION: '17'
  NODE_VERSION: '20'

jobs:
  # ==========================================
  # JOB 1: Code Quality and Security Analysis
  # ==========================================
  code-quality:
    name: ğŸ” Code Quality & Security
    runs-on: ubuntu-latest
    outputs:
      quality-gate: ${{ steps.quality-gate.outputs.result }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Set up Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: ğŸ”— Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: ğŸ›¡ï¸ Run OWASP dependency check
        run: ./mvnw org.owasp:dependency-check-maven:check
        continue-on-error: true

      - name: ğŸ”’ Run Trivy security scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ğŸ“Š Upload security scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: âœ… Quality Gate
        id: quality-gate
        run: echo "result=passed" >> $GITHUB_OUTPUT

  # ==========================================
  # JOB 2: Backend Tests
  # ==========================================
  backend-tests:
    name: ğŸ”§ Backend Tests
    runs-on: ubuntu-latest
    needs: [code-quality]

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: carrental_test
          POSTGRES_USER: carrental_test
          POSTGRES_PASSWORD: test_password_123
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: ğŸ”— Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: ğŸ§ª Run unit tests
        run: ./mvnw clean test -Dspring.profiles.active=test
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/carrental_test
          SPRING_DATASOURCE_USERNAME: carrental_test
          SPRING_DATASOURCE_PASSWORD: test_password_123

      - name: ğŸ”§ Run integration tests
        run: ./mvnw verify -Dspring.profiles.active=test
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/carrental_test
          SPRING_DATASOURCE_USERNAME: carrental_test
          SPRING_DATASOURCE_PASSWORD: test_password_123

      - name: ğŸ“Š Generate test report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Backend Tests
          path: target/surefire-reports/*.xml
          reporter: java-junit

      - name: ğŸ“ˆ Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: target/site/jacoco/jacoco.xml
          flags: backend

  # ==========================================
  # JOB 3: Frontend Tests
  # ==========================================
  frontend-tests:
    name: âš›ï¸ Frontend Tests
    runs-on: ubuntu-latest
    needs: [code-quality]

    defaults:
      run:
        working-directory: ../carrental-frontend

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '../carrental-frontend/package-lock.json'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Run ESLint
        run: npm run lint

      - name: ğŸ¨ Run Prettier check
        run: npx prettier --check "src/**/*.{ts,tsx,js,jsx,json,css,md}"

      - name: ğŸ§ª Run unit tests
        run: npm run test:ci
        env:
          CI: true

      - name: ğŸ”§ Run component tests
        run: npm run test:component || echo "Component tests not configured"

      - name: ğŸ—ï¸ Build application
        run: npm run build

      - name: ğŸ“ˆ Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ../carrental-frontend/coverage/lcov.info
          flags: frontend

      - name: ğŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: frontend-build
          path: ../carrental-frontend/dist
          retention-days: 7

  # ==========================================
  # JOB 4: Build Docker Images
  # ==========================================
  docker-build:
    name: ğŸ³ Docker Build
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    if: github.event_name != 'pull_request'

    outputs:
      backend-image: ${{ steps.backend-meta.outputs.tags }}
      frontend-image: ${{ steps.frontend-meta.outputs.tags }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Backend Image
      - name: ğŸ·ï¸ Extract backend metadata
        id: backend-meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ—ï¸ Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          target: production
          push: true
          tags: ${{ steps.backend-meta.outputs.tags }}
          labels: ${{ steps.backend-meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      # Frontend Image
      - name: ğŸ·ï¸ Extract frontend metadata
        id: frontend-meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ—ï¸ Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ../carrental-frontend
          file: ../carrental-frontend/Dockerfile
          target: production
          push: true
          tags: ${{ steps.frontend-meta.outputs.tags }}
          labels: ${{ steps.frontend-meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  # ==========================================
  # JOB 5: Security Scan Images
  # ==========================================
  security-scan-images:
    name: ğŸ›¡ï¸ Security Scan Images
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: github.event_name != 'pull_request'

    strategy:
      matrix:
        image: [backend, frontend]

    steps:
      - name: ğŸ”’ Run Trivy on ${{ matrix.image }}
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.image == 'backend' && needs.docker-build.outputs.backend-image || needs.docker-build.outputs.frontend-image }}
          format: 'sarif'
          output: '${{ matrix.image }}-trivy-results.sarif'

      - name: ğŸ“Š Upload ${{ matrix.image }} scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: '${{ matrix.image }}-trivy-results.sarif'

  # ==========================================
  # JOB 6: Deploy to Staging
  # ==========================================
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [docker-build, security-scan-images]
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://staging.carrental.com

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to staging
        run: |
          echo "ğŸš€ Deploying to staging environment..."
          echo "Backend image: ${{ needs.docker-build.outputs.backend-image }}"
          echo "Frontend image: ${{ needs.docker-build.outputs.frontend-image }}"

          # TODO: Add actual deployment commands
          # Example for Kubernetes:
          # kubectl set image deployment/carrental-backend carrental-backend=${{ needs.docker-build.outputs.backend-image }}
          # kubectl set image deployment/carrental-frontend carrental-frontend=${{ needs.docker-build.outputs.frontend-image }}

          # Example for Docker Compose:
          # export BACKEND_IMAGE=${{ needs.docker-build.outputs.backend-image }}
          # export FRONTEND_IMAGE=${{ needs.docker-build.outputs.frontend-image }}
          # docker-compose -f docker-compose.staging.yml up -d

      - name: ğŸ§ª Run smoke tests
        run: |
          echo "ğŸ§ª Running smoke tests on staging..."
          # TODO: Add smoke tests
          # curl -f https://staging.carrental.com/api/health
          # curl -f https://staging.carrental.com/

      - name: ğŸ“¢ Notify deployment
        if: always()
        run: |
          echo "ğŸ“¢ Staging deployment ${{ job.status }}"
          # TODO: Add Slack/Teams notification

  # ==========================================
  # JOB 7: Deploy to Production
  # ==========================================
  deploy-production:
    name: ğŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    needs: [docker-build, security-scan-images]
    if: github.ref == 'refs/heads/main' || github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: production
      url: https://carrental.com

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŒŸ Deploy to production
        run: |
          echo "ğŸŒŸ Deploying to production environment..."
          echo "Backend image: ${{ needs.docker-build.outputs.backend-image }}"
          echo "Frontend image: ${{ needs.docker-build.outputs.frontend-image }}"

          # TODO: Add production deployment commands
          # chmod +x deploy-production.sh
          # ./deploy-production.sh

      - name: ğŸ©º Run health checks
        run: |
          echo "ğŸ©º Running health checks on production..."
          # TODO: Add health checks
          # curl -f https://carrental.com/api/health

      - name: ğŸ“¢ Notify deployment
        if: always()
        run: |
          echo "ğŸ“¢ Production deployment ${{ job.status }}"

      - name: ğŸ”„ Rollback on failure
        if: failure()
        run: |
          echo "ğŸ”„ Rolling back production deployment..."
          # TODO: Add rollback commands

  # ==========================================
  # JOB 8: Performance Tests
  # ==========================================
  performance-tests:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: github.ref == 'refs/heads/develop'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš¡ Run load tests
        run: |
          echo "âš¡ Running performance tests..."
          # TODO: Add k6 or Artillery tests
          # k6 run performance-tests/load-test.js

      - name: ğŸ“Š Generate performance report
        run: |
          echo "ğŸ“Š Generating performance report..."
          # TODO: Generate and upload performance reports

  # ==========================================
  # JOB 9: Cleanup
  # ==========================================
  cleanup:
    name: ğŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: [deploy-production, deploy-staging, performance-tests]
    if: always()

    steps:
      - name: ğŸ§¹ Clean up old images
        run: |
          echo "ğŸ§¹ Cleaning up old container images..."
          # TODO: Add cleanup logic for old images

      - name: ğŸ“Š Generate deployment summary
        if: always()
        run: |
          echo "ğŸ“Š Deployment Summary"
          echo "===================="
          echo "Pipeline Status: ${{ job.status }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref }}"
          echo "Trigger: ${{ github.event_name }}"